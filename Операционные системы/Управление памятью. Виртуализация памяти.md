---
date: 2023-09-22
tags:
  - theory
  - operational_systems
---
# Память (оперативная)
Процессор может выполнять только инструкции, находящиеся в оперативной памяти. Память распределяется как между модулями прикладных программ, так и между модулями самой ОС.

## Функции по управлению памятью в мультипрограммной системе
1. Отслеживание свободной и занятой памяти
2. Выделение памяти процессам и ее освобождение при завершении процесса
3. Вытеснение процессов из оперативной памяти на диск при нехватке оперативной памяти и возвращение в оперативную память при освобождении места в ней (механизм виртуальной памяти)
4. Настройка адресов программы на конкретную область физической памяти
5. Динамическое выделение памяти процессам
6. Дефрагментация освобожденной динамической памяти
7. Выделение памяти при создании служебных структур ОС
8. Защита памяти (процесс не имеет доступа к памяти, выделенной под другой процесс)

## Типы адресов
Для идентификации переменных и команд на разных этапах обработки программы ОС используются символьные имена, преобразуемые в виртуальные адреса и в итоге - в физические адреса.

## Виртуальное адресное пространство
Виртуальные адреса для различных программ назначаются транслятором независимо. Диапазон виртуальных адресов определяется программно-аппаратным обеспечением компьютера, в частности, разрядностью его схем адресации. Совокупность всех возможных адресов из этого диапазона называется виртуальным адресным пространством.

Пример:
32-разрядный процессор семейства х86 дает возможность адресовать до 232 байт, т.е. до 4 Гбайт памяти с диапазоном виртуальных адресов от 0х00000000h до 0xFFFFFFFF.

## Образ процесса
Образ процесса - содержимое назначенного процессу виртуального адресного пространства.

## Способы структуризации виртуального пространства в ОС
**Структура адреса**, или **модель адресации**, определяется в совокупности компилятором, операционной системой и аппаратным обеспечением. Компилятор должен обеспечить простоту работы с адресом, но с минимальным разрывом между программистом и ОС. Поэтому в языке программирования отображается та модель, которая используется в ОС. Эта модель, в свою очередь, определяется заложенной в ОС идеей адресации с учетом необходимости реализации этой идеи на конкретной аппаратной платформе. Таким образом, ОС «сверху» должна обеспечить достаточно простую модель адресации для компилятора, а снизу уметь преобразовать эту модель в модель, навязанную аппаратурой.

### Типы виртуальных адресных пространств
#### Плоская структура
ВАП представлено в виде непрерывной линейной последовательности адресов. Линейный виртуальный адрес - число, представляющее собой смещение относительно начала ВАП (обычно нулевое).

#### Сегментированная структура
ВАП представляется разделенным на сегменты, а адрес любого объекта в памяти определяется номером сегмента и смещением относительно начала этого сегмента, т.е. парой сегмент-смещение.

В современных ОС сегмент это некоторая функционально осмысленная часть кода или данных, которая может помещаться в оперативную память или выгружаться из нее как единое целое. Элементы сегмента адресуются внутри него смещением относительно начала. При этом механизм структуризации адресного пространства прозрачен для пользователя, и для процесса и осуществляется аппаратно-программными средствами ОС.

Для программы адресное пространство представляется плоским.

### Подходы к преобразованию виртуальных адресов в физические
- **Статический**. Загрузка совместно с заменой виртуальных адресов физическими. Замена адресов выполняется один раз. Программа перемещающий загрузчик, имея начальный адрес загрузки (т.е. адрес оперативной памяти, начиная с которого будет размещена программа) и код в относительных (виртуальных) адресах, выполняет загрузку с одновременным увеличением виртуальных адресов на величину начального адреса загрузки.
- **Динамический**. Динамическое преобразование виртуальных адресов. Программа загружается в память в виртуальных адресах. Начальный адрес загрузки ОС фиксирует в специальном регистре Преобразование виртуальных адресов в физические (также путем прибавления начального адреса загрузки) производится во время выполнения программы при обращении к памяти. Таким образом, некоторый виртуальный адрес пересчитывается в физический столько раз, сколько обращений по нему производится

## Понятие виртуальной памяти
**Виртуальная память** - картина памяти, формируемая операционной системой для процесса (вспомним, что одна из функций ОС - предоставление виртуальной машины, естественно предположить, что память такой машины тоже должна быть виртуальной) Деятельность ОС по созданию такой картины правомерно назвать виртуализацией памяти.

ОС имеет в своем распоряжении некоторый объем физической оперативной памяти в виде установленных модулей плюс объем, который ей разрешено использовать на диске (от 2 Мб, сверху ограничивается администратором). Эта память распределяется между всеми процессами, включая системные, отдельными фрагментами (страницами). Страницы отдельного процесса располагаются частью оперативной памяти, частью на диске в порядке, устанавливаемом ОС и в общем случае отличном от их последовательности в самом процессе (его виртуальном адресном пространстве). Эффект увеличения объема памяти достигается за счет вытеснения неактивных страница.

## Страничное распределение памяти
### Виды алгоритмов распределения памяти
Без использования внешней памяти
- фиксированными разделами
- динамическими разделами
- перемещаемыми разделами

С использованием внешней памяти
- страничное распределение
- сегментное распределение
- сегментно-страничное распределение

## Виртуализация памяти
Виртуализация оперативной памяти осуществляется совокупностью аппаратных средств процессора и программных средств ОС и включает решение следующих задач:
- размещение данных (образов процессов или их частей) в запоминающих устройствах разного типа: частично в оперативной памяти, частично на диске;
- выбор образов процессов или их частей для перемещения из оперативной памяти на диски обратно;
* перемещение данных между памятью и диском;
- преобразование виртуальных адресов в физические.

### Свопинг/свапинг (swapping)
Свопинг (swapping). Между оперативной памятью и диском перемещаются образы процессов. Более простой в реализации способ, чем виртуальная память. Однако обладает избыточностью при подкачке или выгрузке часто для активизации процесса или освобождения памяти не требуется перемещение всего образа процесса. Избыточность приводит к замедлению работы системы и неэффективному использованию памяти.

Кроме того, невозможно загрузить для выполнения процесс, виртуальное адресное пространство которого превышает имеющуюся в наличии свободную память.

### Виртуальная память
Виртуальная память (virtual memory). Между оперативной памятью и диском перемещаются части образов процессов.

Три класса виртуальной памяти:
- Страничное распределение. Единицей перемещения между памятью и диском является страница - часть виртуального адресного пространства фиксированного и небольшого объема:
* Сегментное распределение. Единицей перемещения между памятью и диском является сегмент часть виртуального адресного пространства произвольного объема, содержащая осмысленную с некоторой точки зрения совокупность данных
- Сегментно-страничное распределение. Объединяет элементы предыдущих классов. Виртуальное адресное пространство структурируется иерархически делится на сегменты, а затем сегменты делятся на страницы. Единицей перемещения между памятью и диском является страница.

#### Страничное распределение
Виртуальное адресное пространство каждого процесса делится на части одинакового, фиксированного для данной системы размера, называемые виртуальными страницами (virtual pages). В общем случае размер виртуального адресного пространства не является кратным размеру страницы, поэтому последняя страница каждого процесса дополняется фиктивной областью.

Вся оперативная память машины также делится на части такого же размера, называемые физическими страницами (блоками, кадрами).

Для каждого процесса ОС создает таблицу страниц - информационную структуру, содержащую записи обо всех виртуальных страницах процесса.

##### Дескриптор страницы
Запись таблицы страниц, называемая дескриптором страницы, включает следующую информацию:
- номер физической страницы, в которую загружена данная виртуальная страница
- признак присутствия виртуальной страницы в оперативной памяти (1 в случае присутствия, 0 - в противном случае)
- признак модификации страницы; устанавливается в 1, когда производится запись по адресу, относящемуся к данной странице, и сбрасывается в 0, когда страница вытесняется из памяти
- признак обращения к странице (бит доступа), устанавливается в 1 при каждом обращении по адресу, относящемуся к данной странице, используется для подсчета числа обращений за определенный период времени
- признак невыгружаемости (выгрузка некоторых страниц может быть запрещена)
- информация о положении каждой вытесненной страницы в страничном файле
- другие данные, формируемые и используемые механизмом виртуальной памяти

##### Схема преобразования виртуального адреса в физический
На уровне аппаратных схем процессора выполняется следующее.
- Из специального регистра извлекается адрес таблицы страниц.
- На основании этого адреса, номера виртуальной страницы и длины записи таблицы страниц определяется адрес нужного дескриптора
- Из этого дескриптора извлекается номер соответствующей физической страницы
* К полученному номеру присоединяется (простым приписыванием, конкатенацией) смещение.

##### Факторы, влияющие на производительность системы
**Частота страничных прерываний и размер страницы.** При часто возникающих страничных прерываниях система може тратить большую часть времени впустую, на свопинг страниц. Чтобы уменьшить частоту страничных прерываний, следовало бы увеличивать размер страницы. Кроме того, увеличение размера страницы уменьшает размер таблицы страниц, в значит уменьшает затраты памяти. С другой стороны, если страница велика, значит велика и фиктивная область в последней виртуальной странице каждой. программы В среднем на каждой программе теряется половина объема страницы, что в сумме при Большой странице может составить существенную величину.

**Время доступа к таблице страниц.** Время преобразования виртуального адреса в физический в значительной степени определяется временем доступа к таблице страниц. В связи с этим таблицу страниц стремятся размещать в "быстрых" запоминающих устройствах Это может быть, например, набор специальных регистров или память, использующая для уменьшения времени доступа ассоциативный поиски кэширование данных.

**Критерий выбора страницы на выгрузку.** Поскольку точно предсказать ход вычислительного процесса невозможно используются эмпирические критерии, часто основывающиеся на предположении об инерционности вычислительного процесса.
Наиболее популярные из таких критериев:
- вытесняется страница, к которой в последнее время было меньше всего обращений
- вытесняется первая попавшаяся страница
- вытесняется дольше всего не использовавшаяся страница.

#### Сегментное распределение
Виртуальное адресное пространство процесса делится на сегменты логические, осмысленные сточки зрения обработки фрагменты (программный код, данные, стек процесса с точки зрения ОС подпрограмм массив данных с точки зрения программиста).

##### Преимущества разбиения на сегменты
Разбиение виртуального адресного пространства на сегменты дает следующие преимущества по сравнению со страничной организацией:
* возможность задания дифференцированных прав доступа процесса к его сегментам (для одних - только чтение, для других чтение и запись и т.д.),
- возможность организации совместного использования фрагментов программ разными процессами (например, использование одной и той же подпрограммы).

##### Сегменты
Виртуальное адресное пространство процесса представляет собой набор виртуальных сегментов.

Основными типами сегментов на уровне ОС являются сегмент данных, сегмент кода, системные сегменты.

Максимальный размер сегмента определяется разрядностью виртуального адреса (4 Гб при 32- разрядной организации).

Каждый сегмент располагает своим независимым виртуальным адресным пространством с адресами от нулевого до максимально возможного.

В каждом сегменте виртуальные адреса задаются парой «номер сегмента смещение внутри сегмента.

Сегментное распределение памяти имеет много общего со страничным. На этапе создания процесса во время загрузки его образа в оперативную память система создает таблицу сегментов процесса (аналогичную таблице страниц), в которой для каждого сегмента указывается:
- начальный физический адрес сегмента в оперативной памяти
* размер сегмента
- права доступа к сегменту
* признаки модификации, присутствия и обращения к данному сегменту за последний интервал времени, а также некоторая другая информация

##### Алгоритм работы с таблицей
Если виртуальные адресные пространства нескольких процессов включают один и тот же сегмент, то в таблицах сегментов этих процессов делаются ссылки на один и тот же участок оперативной памяти, в который данный сегмент загружается в единственном экземпляре.

Для каждого загружаемого сегмента ОС подыскивает непрерывный участок свободной памяти достаточного размера. В оперативную память помещается только часть сегментов; остальные размещаются на диске.

##### Действия при обращении к памяти
Действия при обращении к памяти при сегментной организации, аналогичны действиям при страничной организации (при необходимости прерывание, вытеснение сегмента и т.д.). Используются те же критерии вытеснения Кроме того, при обращении к памяти проверяется, разрешен ли доступ требуемого типа к данному сегменту.

##### Недостатки метода сегментного распределения
**Преобразование виртуального адреса в физический** менее эффективно, чем при страничной организации:
* нельзя получить адрес начала сегмента по его номеру, и в таблице сегментов необходимо задавать полный адрес его начала (при страничной организации достаточно номера)
- физический адрес формируется путем сложения (вместо конкатенации) сегмента и смещения

**Избыточность.** Единица перемещения между памятью и диском сегмент целиком, чего во многих случаях не требуется

**Фрагментация памяти.** При многократной загрузке выгрузке образуются небольшие участки свободной памяти, не вмещающие ни одного сегмента, но в сумме имеющие значительный объем

#### Сегментно-страничное распределение
Виртуальное адресное пространство процесса разделено на сегменты. Это позволяет определять разные права доступа к разным частям ходов данных программы

Перемещение данных между памятью и диском осуществляется страницами, что позволяет минимизировать фрагментацию оперативной памяти. Для этого виртуальное адресное пространство и физическая память делятся на страницы равного размера.

##### Сегментация
**Сегментация**. В большинстве современных реализаций сегментно-страничного распределения виртуальные сегменты образуют одно непрерывное виртуальное адресное пространство.

Адрес в виртуальном адресном пространстве при сегментно-страничном распределений задается парой номер сегмента смещение относительно начала сегмента». Это позволяет проверить принадлежность адрес некоторому сегменту и соответствующие права доступа

Для каждого процесса создается таблица сегментов, содержащая дескрипторы сегментов. В отличие от дескриптора сегмента при сегментном распределении, содержащего физический адрес сегмента, в данном случае в дескриптор заносится начальный (базовый) линейный виртуальный адрес сегмента в пространстве виртуальных адресов.

##### Страничный механизм
**Страничный механизм.** Деление общего линейного виртуального адресного пространства процесса и физической памяти и на страницы и действия при обращении к памяти осуществляются так же, как при страничной организации памяти.

Базовые адреса таблицы сегментов и таблицы страниц являются частью контекста процесса, при активизации процесса загружаются в специальные регистры и используются при преобразовании адресов.

##### Преобразование виртуального адреса в физический
На первом этапе вычисляется адрес поля дескриптора сегмента анализируются права доступа к сегменту. Если доступ разрешен, то виртуальный адрес в виде пары сегмент смещение» преобразуется в линейный виртуальный адрес.

На втором этапе преобразование адреса происходит так же, как при страничной организации.

---
Возможен и другой вариант комбинирования сегментного и страничного механизмов
* виртуальное адресное пространство процесса делится на сегменты
- каждый сегмент на страницы

Виртуальный адрес в таком случае выражается тройкой «сегмент - страница - смещение в странице»